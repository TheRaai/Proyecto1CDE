---
title: "Proyecto 1 CDE"
output:
    bookdown::html_document2:
    fig_caption: yes
bibliography: references.bib
date: "`r Sys.Date()`"
author: "Tomás Cantuarias - Raimundo Moraga - Victor Valero"
knit: (function(inputFile,encoding) {rmarkdown::render(inputFile,encoding=encoding,output_file=file.path(dirname(inputFile),'index.html'))})
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning=FALSE,echo = TRUE)
library(rnaturalearth)
library(rnaturalearthdata)
library(ggplot2)
library(sp)
library(plotly)
library(ggmap)
library(ggridges)
library(knitr)
library(geosphere)
pacman::p_load(tmap, sf, tidyverse, mapview, RColorBrewer, viridis,
               leafpop, leaflet, leaflet.extras, mapdeck, plotly,
               ggiraph, widgetframe, st)
```

```{=html}
<style>
body {
text-align: justify}
</style>
```
## Introducción {.unnumbered}

Dentro de Chile, existen varios tipos de fenómenos geológicos, ya que existen una gran cantidad de montañas, lagos, ríos, playas y puertos. Pero además de estos, existen **glaciares**, que son grandes áreas congeladas, creadas gracias a las bajas temperaturas que se encuentran en las zonas sur del país mayoritariamente. Estos serán los objetos principales de estudio en este informe.

El objetivo de este estudio será poder analizar las áreas de los distintos glaciares existentes en Chile y las ciudades más cercanas a estos, y poder demostrar que los glaciares con áreas mayores tienden a tener una mayor cantidad de ciudades cercanas que aquellos que tienen menores áreas.

```{r include=FALSE}
glaciares <- ne_download(scale = 10, type = 'glaciated_areas', category = 'physical', returnclass = 'sf')
sf_use_s2(FALSE)
pop<- ne_download(scale = 10, type = 'populated_places', category = 'cultural', returnclass='sf')
df <- ne_countries(country = 'chile',returnclass = c("sf"))
filtered_glaciares = st_filter(glaciares, df, .pred = st_intersects)
filtered_ciudades = st_filter(pop, df, .pred = st_intersects)
filtered_glaciares$name <-NULL
filtered_glaciares <- mutate(filtered_glaciares, area = st_area(filtered_glaciares))
latitudes = c(-56, -25)#y
longitudes <- c(-78, -65) #x
pal <- viridis(n=length(unique(glaciares)),direction = 1)
filtered_glaciares <- filtered_glaciares[order(filtered_glaciares$area,decreasing=TRUE),]
```

## Metodología {.unnumbered}

Para poder demostrar esto, se hará uso de la librería **RNaturalEarth** para conseguir las posiciones de los glaciares, utilizando un enfoque para solamente analizar los glaciares que existen en Chile. Esto se hace aplicando un filtro que intersecte un conjunto de datos que contiene las distintas ciudades de Chile, con el conjunto de datos que incluye todos los glaciares del mundo. Al aplicar esto, se consigue que existen 70 glaciares alrededor de todo Chile. Además, se confirma esta data gracias a la información entregada por [@camara.cl].

Luego de esto, se hace un mapa que muestre los glaciares de chile (Ver gráfico \@ref(fig:glaciares)).
```{r echo=FALSE,message=FALSE}
cent <- st_point_on_surface(filtered_glaciares)
cent_temp <- unlist(cent$geometry)
long <- cent_temp[seq(1, length(cent_temp),2)]
lat <- cent_temp[-seq(1, length(cent_temp),2)]
filtered_glaciares['cent_long'] <- long
filtered_glaciares['cent_lat'] <- lat
filtered_glaciares['contenido'] <- paste("Área glaciar: ", round(filtered_glaciares$area/1000000,2), "[Km^2]")
list2 <-list("ciudad1","ciudad2")
filtered_glaciares <- filtered_glaciares %>% mutate(Cercano = I(list(c(list2))))
for (n in 1:70){ #recorre los glaciares de uno en uno
  x <- list()
  i = 1
  for(m in 1:77){#recorre las ciudades de una en una
    dist = distm(c(filtered_glaciares$cent_long[n], filtered_glaciares$cent_lat[n]), c(filtered_ciudades$LONGITUDE[m], filtered_ciudades$LATITUDE[m]), fun = distHaversine)
    dist = dist/1000 #pasa la distancia en metro a KM
    #print(dist)
    if(dist <= 200){
      #print("menor a 3000")
      x[i] <- filtered_ciudades$NAMEASCII[m]
      i <- i+1
    }
  }
  filtered_glaciares$Cercano[n] <- I(list(c(x)))
}
```

```{r glaciares,fig.cap="Mapa glaciares",echo=FALSE}
int_map <- filtered_glaciares %>% leaflet() %>% addProviderTiles("OpenStreetMap", group = "openstreetmap") %>%
setView(lng = -71.5430, lat = -35.6751, zoom =4) %>% 
  addPolygons(data = filtered_glaciares$geometry, 
              fillColor  = pal,
              fillOpacity = 0.8,
              color = "#FFFF00", 
              weight = 1) %>% 
  addMarkers(lng = filtered_glaciares$cent_long,
             lat = filtered_glaciares$cent_lat, 
             popup = filtered_glaciares$contenido) %>%
  addProviderTiles("Stamen.Terrain",
                   group = "Stamen.Terrain"
  ) %>% 
  addLayersControl(
    baseGroups = c(
      "OpenStreetMap",
      "Stamen.Terrain"),
    position = "topleft"
  )
int_map
```

## Datos {.unnumbered}

Luego de filtrar los glaciares Chilenos, y conseguir las áreas de estos, se pueden resumir en la tabla \@ref(tab:tabla-1):

```{r tabla-1, echo=FALSE}
knitr::kable(head(filtered_glaciares$area,15),col.names='Área',digits = 3, format.args = list(big.mark = ",",scientific = FALSE),align='c',row.names = FALSE,caption="15 mayores áreas")
```

Si bien se encuentran solamente los 15 glaciares con mayores áreas, se puede encontrar la tabla entera en la sección de [anexos]. Luego de esto se procede a analizar la distancia de los glaciares con las ciudades, para poder relacionar cada glaciar con una ciudad.

Para realizar este análisis, se procedió a tomar una distancia Haversine entre cada glaciar y todas las ciudades, para luego aplicar un criterio de distancia para de esta manera proceder a definir qué distancia cumplía con el criterio de estar "cerca" al glaciar y cuáles no. Este umbral fué determinado como **menor o igual a 200 [km]** Y de esta manera poder determinar la cantidad de ciudades que se encuentren a menos de 200 [km] de un glaciar. 

Con este criterio, se logró crear la tabla \@ref(tab:tabla-2) que muestra los glaciares y las ciudades que estaban cerca de estos. 
```{r tabla-2, echo=FALSE}
subset <- filtered_glaciares[c("area","Cercano")]
subset$Cercano <- lengths(subset$Cercano)
subset$geometry<-NULL
knitr::kable(head(subset,15),col.names=c("Glaciar","Cantidad de ciudades cercanas"),row.names = FALSE,align='c',caption="15 glaciares mayores con ciudades cercanas")
```

Viendo esta tabla (tabla completa se encuentra [anexos]), se puede analizar la cantidad de ciudades que existen cerca de estos glaciares, en donde se ve que el mayor número de ciudades cercanas es **14** (revisar tabla \@ref(tab:tabla-c)), pero este glaciar no se encuentra nisiquiera entre los 15 con mayores áreas. Por otro lado, se puede ver que el glaciar con máyor área solamente tiene 1 ciudad cercana, que en esta caso sería **Villa O'Higgins**. Esto se puede dar gracias a que el glaciar se encuentra en la zona sur patagónica del país, por lo que no existen muchos lugares poblados por ese sector, dadas las condiciones atmosféricas del sur Chileno. Si bien revisando la tabla se puede ver que la hipótesis inicial de que a mayor área del glaciar, una mayor cantidad de ciudades cercanas no se cumple, se puede revisar un variograma para poder revisar la correlación entre estas dos variables. 

Revisar gráfico \@ref(fig:vario).
```{r vario,fig.cap="Variograma área de glacias vs cantidad de ciudades cercanas",echo=FALSE}
plot(subset)
```
## Bibliografía {-}

<div id="refs"></div>

## Anexos {.unnumbered}

```{r anexo, echo=FALSE}
knitr::kable(filtered_glaciares$area,col.names='Área',digits = 3, format.args = list(big.mark = ",",scientific = FALSE),align='c',row.names = FALSE,caption='Áreas glaciares')
```
```{r tabla-c,echo=FALSE}
knitr::kable(subset,col.names=c("Glaciar","Cantidad de Ciudades"),row.names = FALSE,align='c',caption="Glaciares con ciudades cercanas")
```